[
 {
  "docstatus": 0,
  "doctype": "Custom HTML Block",
  "html": "<div class=\"eea2-widget\">\r\n  <div class=\"eea2-filterbar\"></div>\r\n  <div class=\"eea2-table mt-3\"></div>\r\n</div>\r\n",
  "modified": "2025-08-27 12:43:29.205823",
  "name": "EEA2 Employment Equity Widget",
  "private": 0,
  "roles": [
   {
    "parent": "EEA2 Employment Equity Widget",
    "parentfield": "roles",
    "parenttype": "Custom HTML Block",
    "role": "System Manager"
   },
   {
    "parent": "EEA2 Employment Equity Widget",
    "parentfield": "roles",
    "parenttype": "Custom HTML Block",
    "role": "IR Manager"
   },
   {
    "parent": "EEA2 Employment Equity Widget",
    "parentfield": "roles",
    "parenttype": "Custom HTML Block",
    "role": "IR Officer"
   }
  ],
  "script": "// EEA2 table widget (Custom HTML Block).\r\n// - Auto-loads with default Company + \"South Africa\"\r\n// - Filters hidden by default; toggle button shows a panel\r\n// - Uses the report-backed API for data\r\n(function () {\r\n  // --- helpers\r\n  function esc(v) { v = v == null ? \"\" : String(v); return frappe.utils.escape_html(v); }\r\n  function q(sel) { return root_element.querySelector(sel); }\r\n\r\n  // DOM anchors inside this block only\r\n  var root = root_element;\r\n  var bar  = q(\".eea2-filterbar\");\r\n  var wrap = q(\".eea2-table\");\r\n\r\n  // Style + toggle button\r\n  var css = document.createElement(\"style\");\r\n  css.textContent = `\r\n    .eea2-widget { position: relative; }\r\n    .eea2-filterbar { display:none; background:#fff; border:1px solid var(--border-color,#dfe3e8); padding:8px; border-radius:8px; box-shadow:0 6px 16px rgba(0,0,0,0.08); position:relative; z-index:1; }\r\n    .eea2-filterbar .form-control { min-width: 220px; }\r\n    .eea2-filter-toggle { position:absolute; right:0; top:0; }\r\n    .eea2-table table { width:100%; border-collapse:collapse; }\r\n    .eea2-table th, .eea2-table td { border:1px solid var(--border-color,#dfe3e8); padding:6px 8px; }\r\n    .eea2-table th { background:#f5f7fa; }\r\n    .text-right { text-align:right; } .text-center { text-align:center; }\r\n  `;\r\n  root.appendChild(css);\r\n\r\n  var toggle = document.createElement(\"button\");\r\n  toggle.type = \"button\";\r\n  toggle.className = \"btn btn-sm btn-secondary eea2-filter-toggle\";\r\n  toggle.textContent = \"Filters\";\r\n  toggle.addEventListener(\"click\", function () {\r\n    bar.style.display = bar.style.display === \"none\" ? \"block\" : \"none\";\r\n  });\r\n  root.appendChild(toggle);\r\n\r\n  // Build filter controls (hidden initially)\r\n  bar.classList.add(\"form-inline\", \"gap-2\", \"align-items-end\");\r\n\r\n  var fCompany = makeLink(bar, {\r\n    fieldname: \"company\",\r\n    label: \"Company\",\r\n    options: \"Company\",\r\n    reqd: 1,\r\n    defaultValue: frappe.defaults.get_default(\"company\") || frappe.sys_defaults.company || \"\"\r\n  });\r\n\r\n  var fCountry = makeLink(bar, {\r\n    fieldname: \"country\",\r\n    label: \"Country (RSA)\",\r\n    options: \"Country\",\r\n    reqd: 1,\r\n    defaultValue: \"South Africa\"\r\n  });\r\n\r\n  var fBranch = makeLink(bar, {\r\n    fieldname: \"branch\",\r\n    label: \"Branch\",\r\n    options: \"Branch\",\r\n    reqd: 0,\r\n    defaultValue: \"\"\r\n  });\r\n\r\n  // Disabled checkbox\r\n  var dWrap = document.createElement(\"div\");\r\n  dWrap.className = \"ml-2\";\r\n  dWrap.innerHTML =\r\n    '<label class=\"mb-0\" style=\"font-size:12px;\">&nbsp;</label><br/>' +\r\n    '<label class=\"mb-0\"><input type=\"checkbox\" class=\"eea2-disabled\"> Disabled Only</label>';\r\n  bar.appendChild(dWrap);\r\n  var chkDisabled = dWrap.querySelector(\".eea2-disabled\");\r\n\r\n  // Refresh when any filter changes\r\n  [fCompany, fCountry, fBranch].forEach(function (c) {\r\n    if (c.$input) c.$input.on(\"change\", refresh);\r\n  });\r\n  chkDisabled.addEventListener(\"change\", refresh);\r\n\r\n  // --- initial auto-render with defaults (no user interaction)\r\n  var initialFilters = {\r\n    company: fCompany.get_value() || (frappe.defaults.get_default(\"company\") || frappe.sys_defaults.company || \"\"),\r\n    country: fCountry.get_value() || \"South Africa\",\r\n    branch:  fBranch.get_value()  || \"\",\r\n    disabled: 0\r\n  };\r\n  fetchAndRender(initialFilters);           // immediate draw\r\n  // also run a tiny delayed refresh in case controls finish async init\r\n  setTimeout(refresh, 150);\r\n\r\n  // ---- functions\r\n  function makeLink(parent, cfg) {\r\n    var wrap = document.createElement(\"div\");\r\n    wrap.className = \"mr-2\";\r\n    wrap.innerHTML =\r\n      '<label class=\"mb-0\" style=\"font-size:12px;\">' + esc(cfg.label) + \"</label>\" +\r\n      '<div class=\"eea2-input\"></div>';\r\n    parent.appendChild(wrap);\r\n\r\n    var control = frappe.ui.form.make_control({\r\n      parent: wrap.querySelector(\".eea2-input\"),\r\n      df: { fieldtype: \"Link\", fieldname: cfg.fieldname, label: cfg.label, options: cfg.options, reqd: cfg.reqd ? 1 : 0 },\r\n      render_input: true\r\n    });\r\n    if (cfg.defaultValue) control.set_value(cfg.defaultValue);\r\n    return control;\r\n  }\r\n\r\n  function getFilters() {\r\n    return {\r\n      company: fCompany.get_value(),\r\n      country: fCountry.get_value(),\r\n      branch:  fBranch.get_value() || \"\",\r\n      disabled: chkDisabled.checked ? 1 : 0\r\n    };\r\n  }\r\n\r\n  function refresh() {\r\n    var f = getFilters();\r\n    if (!f.company || !f.country) {\r\n      wrap.innerHTML = '<div class=\"text-muted\">Select Company and Country to load the table.</div>';\r\n      return;\r\n    }\r\n    fetchAndRender(f);\r\n  }\r\n\r\n  function fetchAndRender(f) {\r\n    wrap.innerHTML = '<div class=\"text-muted\">Loadingâ€¦</div>';\r\n    frappe.call({\r\n      method: \"ir.industrial_relations.api.eea2.get_eea2_data\",\r\n      args: { filters: f },\r\n      freeze: false,\r\n      callback: function (r) {\r\n        var rows = (r && r.message && r.message.rows) ? r.message.rows : [];\r\n        renderTable(rows);\r\n      },\r\n      error: function () { wrap.innerHTML = '<div class=\"text-danger\">Failed to load data.</div>'; }\r\n    });\r\n  }\r\n\r\n  function renderTable(rows) {\r\n    var head =\r\n      \"<thead>\" +\r\n      \"<tr>\" +\r\n      '<th rowspan=\"2\" style=\"min-width:320px\">Occupational Levels</th>' +\r\n      '<th colspan=\"4\" class=\"text-center\">Male</th>' +\r\n      '<th colspan=\"4\" class=\"text-center\">Female</th>' +\r\n      '<th colspan=\"2\" class=\"text-center\">Foreign Nationals</th>' +\r\n      '<th rowspan=\"2\" class=\"text-right\">Total</th>' +\r\n      \"</tr>\" +\r\n      \"<tr>\" +\r\n      \"<th>A</th><th>C</th><th>I</th><th>W</th>\" +\r\n      \"<th>A</th><th>C</th><th>I</th><th>W</th>\" +\r\n      \"<th>Male</th><th>Female</th>\" +\r\n      \"</tr>\" +\r\n      \"</thead>\";\r\n\r\n    var body = rows.map(function (r) {\r\n      var style = r.is_total_row ? \"font-weight:600;background:#fafafa;\" : \"\";\r\n      return (\r\n        '<tr style=\"' + style + '\">' +\r\n          \"<td>\" + esc(r.occupational_level) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.a_male || 0) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.c_male || 0) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.i_male || 0) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.w_male || 0) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.a_female || 0) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.c_female || 0) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.i_female || 0) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.w_female || 0) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.foreign_male || 0) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.foreign_female || 0) + \"</td>\" +\r\n          '<td class=\"text-right\">' + (r.total || 0) + \"</td>\" +\r\n        \"</tr>\"\r\n      );\r\n    }).join(\"\");\r\n\r\n    wrap.innerHTML = '<table class=\"table table-bordered\">' + head + \"<tbody>\" + body + \"</tbody></table>\";\r\n  }\r\n})();\r\n",
  "style": null
 }
]